<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--<dao namespace="UserSqlMap">-->
<mapper namespace="com.great.childschool.mapper.TjzBackMapper">


    <!--    文件上传-->
    <insert id="upload" parameterType="com.great.childschool.entity.TjzTblSafeStudy">
        INSERT INTO tbl_safestudy(safename,startdate,enddate)
        VALUES (#{safeName},#{startDate},#{endDate})
    </insert>


    <!-- 教师安全教育试题表格-->
    <select id="safeStudy" parameterType="map" resultType="com.great.childschool.entity.TjzTblSafeStudy">
        SELECT *
        FROM tbl_safestudy
        <where>
            <if test="safeName !=null and safeName!=''">
                AND safename like '%' #{safeName} '%'
            </if>
            <if test="startDate !=null and startDate!=''">
                AND safedate &gt;= #{startDate}
            </if>
            <if test="endDate !=null and endDate!=''">
                AND safedate &lt;= #{endDate}
            </if>
        </where>
        LIMIT #{pstart},#{psize}
    </select>

    <!--教师发布安全教育试题数量-->
    <select id="safeStudyNum" parameterType="map" resultType="int">
        SELECT COUNT(safeid)
        FROM tbl_safestudy
        <where>
            <if test="safeName !=null and safeName!=''">
                AND safename like '%' #{safeName} '%'
            </if>
            <if test="startDate !=null and startDate!=''">
                AND safedate &gt;= #{startDate}
            </if>
            <if test="endDate !=null and endDate!=''">
                AND safedate &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 按人员统计日志-->
    <select id="logCountByWid" parameterType="com.great.childschool.entity.TjzTblParent" resultType="com.great.childschool.entity.TjzLogCount">
     SELECT wo.wname,lc.*
     FROM tbl_worker wo,(
     SELECT lo.wid,COUNT(lo.wid) AS 'count'
     FROM tbl_log lo
     GROUP BY lo.wid) lc
     WHERE wo.wid=lc.wid
    </select>

    <!-- 按月统计日志-->
    <select id="logCountByMonth" parameterType="com.great.childschool.entity.TjzTblParent" resultType="com.great.childschool.entity.TjzLogCount">
      SELECT YEAR(ldate) AS 'year' , MONTH(ldate) AS 'month' , COUNT(*) AS 'count'
      FROM tbl_log
      GROUP BY YEAR (ldate) DESC, MONTH(ldate)
    </select>


    <!-- 家长修改密码-->
    <update id="parentChangePassword" parameterType="com.great.childschool.entity.TjzTblParent" >
       UPDATE tbl_parent SET ppsw=#{ppsw} WHERE pid=#{pid}
    </update>

    <!-- 家长查询旧密码是否正确-->
    <select id="parentOldPassword" parameterType="com.great.childschool.entity.TjzTblParent" resultType="com.great.childschool.entity.TjzTblParent">
       SELECT tbl_parent.ppsw
       FROM tbl_parent
       WHERE tbl_parent.pid=#{pid}
    </select>


    <!-- 家长查询课程-->
    <select id="parentCourseTable" parameterType="map" resultType="com.great.childschool.entity.TjzTbCourse">
        SELECT co.couid,sub.subname,co.cdate,co.corder,sub.subid
        FROM tbl_baby ba,tbl_course co,tbl_subject sub
        WHERE ba.bid=#{bid}
        AND ba.cid=co.cid
        AND co.subid = sub.subid
        AND co.cdate &gt;= #{startDate}
        AND co.cdate &lt;= #{endDate}
    </select>


    <!-- 家长查询孩子班级-->
    <select id="parentCourseQuery" parameterType="map" resultType="com.great.childschool.entity.TjzTbClassRoom">
        SELECT ba.bid,ba.bname,cl.cid,cl.cname,wo.wname,cl.classroom
        FROM tbl_parent_baby pb,tbl_baby ba,tbl_classroom cl,tbl_worker wo
        WHERE pb.pid=#{pid}
        AND pb.bid=ba.bid
        AND ba.cid=cl.cid
        AND wo.wid=cl.wid
    </select>


    <!--家长查询孩子班级数量-->
    <select id="parentCourseQueryNum" parameterType="map" resultType="int">
        SELECT COUNT(ba.bid)
       FROM tbl_parent_baby pb,tbl_baby ba,tbl_classroom cl,tbl_worker wo
        WHERE pb.pid=#{pid}
        AND pb.bid=ba.bid
        AND ba.cid=cl.cid
        AND wo.wid=cl.wid
    </select>


    <!-- 教师查询班级-->
    <select id="teacherCourseQuery" parameterType="map" resultType="com.great.childschool.entity.TjzTbClassRoom">
        SELECT cl.cid,cl.cname,wo.wname,cl.classroom,cl.courseadddate
        FROM tbl_classroom cl,tbl_worker wo
        WHERE cl.wid=wo.wid
        AND wo.wid=#{wid}
        <if test="cName !=null and cName!=''">
            AND cl.cname like '%' #{cName} '%'
        </if>
        <if test="startDate !=null and startDate!=''">
            AND cl.courseadddate &gt;= #{startDate}
        </if>
        <if test="endDate !=null and endDate!=''">
            AND cl.courseadddate &lt;= #{endDate}
        </if>
        LIMIT #{pstart},#{psize}
    </select>

    <!--教师查询班级数量-->
    <select id="teacherCourseQueryNum" parameterType="map" resultType="int">
        SELECT COUNT(cl.cid)
        FROM tbl_classroom cl,tbl_worker wo
        WHERE cl.wid=wo.wid
        AND wo.wid=#{wid}
        <if test="cName !=null and cName!=''">
            AND cl.cname like '%' #{cName} '%'
        </if>
        <if test="startDate !=null and startDate!=''">
            AND cl.courseadddate &gt;= #{startDate}
        </if>
        <if test="endDate !=null and endDate!=''">
            AND cl.courseadddate &lt;= #{endDate}
        </if>
    </select>

    <!-- 教师查询课程-->
    <select id="teacherCourseTable" parameterType="map" resultType="com.great.childschool.entity.TjzTbCourse">
        SELECT co.couid,sub.subname,co.cdate,co.corder,sub.subid
        FROM tbl_course co,tbl_subject sub,tbl_classroom cl
        WHERE co.subid = sub.subid
        AND cl.wid=#{wid}
        AND cl.cid=#{cid}
        AND cl.cid=co.cid
        AND co.cdate &gt;= #{startDate}
        AND co.cdate &lt;= #{endDate}
    </select>

    <!-- 园长排课-->
    <update id="addSubject">
            UPDATE tbl_course set subid =#{subId} WHERE couid=#{couId}
     </update>

    <!-- 科目下拉框-->
    <select id="findSubject" parameterType="int" resultType="com.great.childschool.entity.TjzTbSubject">
        SELECT * FROM tbl_subject
    </select>

    <!-- 园长查询课程-->
    <select id="courseTable" parameterType="map" resultType="com.great.childschool.entity.TjzTbCourse">
        SELECT co.couid,sb.subname,co.cdate,co.corder,sb.subid
        FROM tbl_course co,tbl_subject sb,tbl_classroom cl
        WHERE co.subid=sb.subid
        AND co.cid=cl.cid
        AND cl.cid=#{cid}
        AND co.cdate &gt;= #{startDate}
        AND co.cdate &lt;= #{endDate}
    </select>

    <!-- 园长查询班级-->
    <select id="courseManagement" parameterType="map" resultType="com.great.childschool.entity.TjzTbClassRoom">
        SELECT cl.cid,cl.cname,wo.wname,cl.classroom,cl.courseadddate
        FROM tbl_classroom cl,tbl_worker wo
        WHERE cl.wid=wo.wid
            <if test="cName !=null and cName!=''">
                AND cl.cname like '%' #{cName} '%'
            </if>
            <if test="startDate !=null and startDate!=''">
                AND cl.courseadddate &gt;= #{startDate}
            </if>
            <if test="endDate !=null and endDate!=''">
                AND cl.courseadddate &lt;= #{endDate}
            </if>
        LIMIT #{pstart},#{psize}
    </select>

    <!--园长查询班级数量-->
    <select id="courseManagementNum" parameterType="map" resultType="int">
        SELECT COUNT(cl.cid)
        FROM tbl_classroom cl,tbl_worker wo
        WHERE cl.wid=wo.wid
        <if test="cName !=null and cName!=''">
            AND cl.cname like '%' #{cName} '%'
        </if>
        <if test="startDate !=null and startDate!=''">
            AND cl.courseadddate &gt;= #{startDate}
        </if>
        <if test="endDate !=null and endDate!=''">
            AND cl.courseadddate &lt;= #{endDate}
        </if>
    </select>

    <!-- 查询日志-->
    <select id="findLog" parameterType="map" resultType="com.great.childschool.entity.TjzTbLog">
        SELECT l.lid,l.ltime,l.ldate,l.levent,wo.wname FROM tbl_log l,tbl_worker wo
        WHERE l.wid=wo.wid
            <if test="wName !=null and wName!=''">
                AND wo.wname like '%' #{wName} '%'
            </if>
            <if test="startDate !=null and startDate!=''">
                AND l.ldate &gt;= #{startDate}
            </if>
            <if test="endDate !=null and endDate!=''">
                AND l.ldate &lt;= #{endDate}
            </if>
        ORDER BY l.ldate DESC,l.ltime DESC
        LIMIT #{pstart},#{psize}
    </select>

    <!--    查询日志数量-->
    <select id="findLogNum" parameterType="map" resultType="int">
        SELECT COUNT(l.lid) FROM tbl_log l,tbl_worker wo
        WHERE l.wid=wo.wid
        <if test="wName !=null and wName!=''">
            AND wo.wname like '%' #{wName} '%'
        </if>
        <if test="startDate !=null and startDate!=''">
            AND l.ltime &gt;= #{startDate}
        </if>
        <if test="endDate !=null and endDate!=''">
            AND l.ltime &lt;= #{endDate}
        </if>
    </select>

    <!--    添加日志-->
    <insert id="addLog" parameterType="com.great.childschool.entity.TjzTbLog">
        INSERT INTO tbl_log(wid,ltime,levent,ldate)
        VALUES (#{wid},#{lTime},#{lEvent},#{lDate})
    </insert>

    <!-- 批量插入未排班课程 -->
    <insert id ="insertCodeBatch" parameterType="java.util.List" >
        <selectKey resultType ="java.lang.Integer" keyProperty= "id"
                   order= "AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey >
        insert into tbl_course
        (cdate, cid, subid, corder)
        values
        <foreach collection ="list" item="course" index= "index" separator =",">
            (
            #{course.cDate},
            #{course.cid},
            #{course.subId},
            #{course.cOrder}
            )
        </foreach >
    </insert >


</mapper>